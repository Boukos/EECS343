<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-gb" lang="en-gb" dir="ltr" >
<head>
      <base href="http://www.aqualab.cs.northwestern.edu/class/335-eecs-343-project-2-xv6)" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Fabián E. Bustamante" />
  <meta name="generator" content="Joomla! - Open Source Content Management" />
  <title>EECS343-Project-xv6-2</title>
  <link href="/templates/aqualab-classes/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon" />
  <link rel="stylesheet" href="/media/com_attachments/css/attachments_hide.css" type="text/css" />
  <link rel="stylesheet" href="/media/com_attachments/css/attachments_list.css" type="text/css" />
  <style type="text/css">

@import url('/css/classes/classes.css');
@import url('/css/classes/jquery-ui.css');
ol.second{ list-style-type:lower-latin; }
ul{padding-top: 1.0em;}

  </style>
  <script src="/media/system/js/mootools-core.js" type="text/javascript"></script>
  <script src="/media/system/js/core.js" type="text/javascript"></script>
  <script src="/media/system/js/caption.js" type="text/javascript"></script>
  <script src="/media/system/js/mootools-more.js" type="text/javascript"></script>
  <script src="/media/com_attachments/js/attachments_refresh.js" type="text/javascript"></script>
  <script type="text/javascript">
window.addEvent('load', function() {
				new JCaption('img.caption');
			});
  </script>

    <link rel="shortcut icon" href="/templates/aqualab-classes/favicon.ico" />
    <link rel="stylesheet" href="/templates/aqualab-classes/css/classes.css" type="text/css" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>


<div id="system-message-container">
</div>
<div class="item-page">









 

<style>
  .code { font-family: monospace; display: inline; font-size: 1.3em;}
</style>
<script type="text/javascript" src="/js/jquery-ui.js"></script>
<script type="text/javascript">
  jQuery(function() {jQuery( "#tabs" ).tabs();});
</script>
<h2>EECS 343 Operating Systems -- Project 2 -- Virtual memory on xv6 </h2>

<div id="tabs">
  <ul>
    <li><a href="#project">Project Description</a></li>
    <li><a href="#submission">Submission Instructions</a></li>
    <!--
    <li><a href="#ec">Extra Credit</a></li>
    <li><a href="#plan">Plan of Attack</a></li>
    <li><a href="#testing">Testing</a></li>
    <li><a href="#background">Background Info</a></li>
    <li><a href="#deliverable">Grading &amp; Deliverables</a></li>
    -->
  </ul>
  
  
  <div id="main" style="width: 100%;">
    <!------------------------------------------------>
    <div id="project">
      
      <h2>Project 2: Virtual Memory on xv6</h2>
      
      <h3>Important Dates</h3>
      <p><b>Out:</b> Wednesday, October 5th, 2016.</p>
      <p><s><b>Due:</b> Friday, October 14th, 2016 (11:59 PM CDT).</s></p>
      <p><b>Due:</b> Tuesday, October 18th, 2016 (11:59 PM CDT).</br>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        Since we are extending the deadline, NO LATE SUBMISSIONS WILL BE ACCEPTED FOR THIS PROJECT.
      </p>
      <!--
      <p><strong>To submit your project (<em>ASCII text only!</em>)</strong> use the following page: <a href="https://www.cs.northwestern.edu/~aqualab/assignments/OS/submission.htm">SUBMISSIONS</a>. </p>
      -->
      <p><b>Submission instructions:</b> Click the "Submission Instructions" tab above.</p>
      
      
      <h3>Resources</h3>
      <ul>
        <li>Some useful GDB and QEMU commands: <a href="https://pdos.csail.mit.edu/6.828/2016/labguide.html" target="_blank">https://pdos.csail.mit.edu/6.828/2016/labguide.html</a></li>
        <li>xv6 textbook: <a href="https://pdos.csail.mit.edu/6.828/2012/xv6/book-rev7.pdf" target="_blank">https://pdos.csail.mit.edu/6.828/2012/xv6/book-rev7.pdf</a><br/> (note that we are using a version of the code from 2012)</li>
        <li>Guide to xv6 codebase: <a href="https://pdos.csail.mit.edu/6.828/2012/xv6/xv6-rev7.pdf" target="_blank">https://pdos.csail.mit.edu/6.828/2012/xv6/xv6-rev7.pdf</a></li>
        <li>Hexadecimal converter: <a href="https://www.mathsisfun.com/binary-decimal-hexadecimal-converter.html" target="_blank">https://www.mathsisfun.com/binary-decimal-hexadecimal-converter.html</a></li>
      </ul>
      
      <h3>Project Overview</h3>
      <p>In this project you will become familiar with the xv6 virtual memory system and work to add a few features that are common in modern OSes. The project is composed of two parts, which you must complete in order.  This project must be completed in groups of 2-3 people.</p>
      
      <p><b>Part 1</b> (40 points)<br/>
        In part 1, you will change the virtual memory space of user processes so that the address <span class="code">0x0</span> is invalid.  Currently, <span class="code">0x0</span> (<span class="code">NULL</span>) is a valid address for an xv6 user process.  You will change xv6 so that dereferencing address <span class="code">0x0</span> causes a page fault.</p>
      
      <p><b>Part 2</b> (60 points)<br/>
        In part 2, you will implement shared memory in xv6.  This will be built upon your part 1 code.  Currently, each process in xv6 has the same virtual address space, but each process's virtual address space maps to disjoint sets of physical pages.  This prevents processes from accidentally (or intentionally) corrupting each other’s memory.  You will change xv6 so that processes can share a limited number of physical memory pages.
      </p>
      
      <p><b>Extra credit</b> (20 points)<br/>
        There is an optimization that can be added to your shared memory implementation for extra credit.</p>
      
      <h3>Educational Objectives</h3>
      
      <p>This project aims to achieve several educational objectives:</p>
      <ul>
        <li>Understand how virtual memory is implemented.  In particular, understand how virtual addresses are mapped to physical addresses using a page directory and page tables.</li>
        <li>Understand how virtual memory is used to prevent processes from corrupting each other's memory.</li>
        <li>Learn how to implement shared memory and why it is useful.</li>
        <li>Practice writing your own test cases.</li>
        <li>Continue to hone your skills as an OS developer.</li>
      </ul>
      
      <h3>The Code</h3>
      
      <p>You can either build upon the code that you submitted in Project 1, or you can start from a clean version of the <a href="http://www.aqualab.cs.northwestern.edu/class/333-eecs343-xv6#download-xv6">original xv6 code</a>. </p>
      
      <h3>Part 1: Making the null pointer invalid</h3>
      <p><b>40 points</b></p>
      
      <p>In your prior C programming experience, you probably became somewhat familiar with the <a href="https://en.wikipedia.org/wiki/Null_pointer" target="_blank">null pointer</a>.  In particular, you know that dereferencing a pointer whose value is <span class="code">0x0</span> (<span class="code">NULL</span>) causes a segmentation fault.  The null pointer serves as a convenient <a href="https://en.wikipedia.org/wiki/Sentinel_value" target="_blank">sentinel value</a> because, in most operating systems, address <span class="code">0x0</span> is reserved for system use, which means that user programs should not be accessing that address anyway.</p>
      
      <p>However, in xv6, address <span class="code">0x0</span> is a valid virtual address.  A user process’s address space goes from <span class="code">0x0</span> to <span class="code">0xA0000</span> (<span class="code">USERTOP</span>).  This means that you can write a C program that dereferences a null pointer and run it on xv6 without causing a segmentation fault.  Give it a try!  You will be able to use this program later to test your work.</p>
      
      <h4>Your Task</h4>
      
      <p>Your task is to modify how xv6 manages the user virtual address space so that <span class="code">0x0</span> is no longer a valid address.  In particular, if a user program tries to dereference a null pointer, xv6 should trap and kill the process.  Luckily for you, xv6 does this automatically for invalid memory accesses.</p>
      
      <p>Your modifications must not prevent xv6 from functioning normally.  In other words, don’t break anything.</p>
      
      <h4>Guidance and hints</h4>
      
      <ol>
        <li>Make sure you understand how xv6 uses a page directory and page tables to map a process’s virtual memory to physical memory.  In particular, understand what the different bits in a Page Directory Entry and Page Table Entry mean.  Chapter 2 of the <a href="https://pdos.csail.mit.edu/6.828/2012/xv6/book-rev7.pdf" target="_blank">xv6 textbook</a> is a useful reference.  How does a Page Table Entry differ for a valid page compared to an invalid page?</li>
        <li>Look at the <span class="code">exec()</span> function to understand what memory-related tasks are involved in executing a new process.  Make a list of the memory-related functions that are being called, look at how they are implemented and decide which ones will need to change.</li>
        <li>Look at the <span class="code">fork()</span> function.  Again, figure out which memory-related functions are being called and which ones need to change.</li>
        <li>Keep digging through the rest of the code to find other places that need to change.  There are several places where the kernel code makes checks on addresses and pointers.  These checks are often based on the implicit assumption that the process’s address space begins at <span class="code">0x0</span>.  For example, when a user program passes an argument in a syscall, the kernel checks the validity of the argument.  Some of these checks may need to change.</li>
        <li>Have a look at <span class="code">user/makefile.mk</span>.  This file dictates that user programs are compiled so that their entry point (first instruction) is loaded at address <span class="code">0x0</span>.  Since you are changing xv6 so that the first page is invalid, the entry point for user programs will have to change accordingly.  For example, you can use the first address of the second page: <span class="code">0x1000</span>.</li>
        <li>Be bold.  In Project 1, you simply had to add code to xv6, so you didn’t have to worry about breaking the existing functionality.  In this project, you actually have to modify the provided code.  There is no way around it.  You will probably break something.  Don’t let this scare you.  You will be able to repair the damage you cause.</li>
        <li>
          When you type <span class="code">ls</span> in xv6, you may have noticed a user program called <span class="code">usertests</span>.  This program runs a series of tests to make sure your kernel is working properly.  The problem is that the changes you are making to the xv6 kernel in this project will invalidate some of the assumptions that underly the tests in <span class="code">usertests</span>.  Here is a slightly modified version of usertests that relaxes the invalid assumptions: <a href="http://www.aqualab.cs.northwestern.edu/component/attachments/download/703">usertests_2_1</a> (You're welcome.)</br></br>
          
          If you prefer, you can download the file from the command line using:</br>
          <p class="code">$ wget http://www.aqualab.cs.northwestern.edu/component/attachments/download/703 -O usertests_2_1.c.tar.gz</p>
        </li>
      </ol>
      
      <h3>Part 2: Implement shared memory</h3>
      <p><b>60 points</b></p>
      
      <p>xv6 is currently structured to map each process’s virtual address space to disjoint sets of physical pages.  In other words, every process’s memory is non-overlapping with every other process’s memory.</p>
      
      <p>In this project, you will allow processes to share up to four pages of memory with each other.  Sharing memory allows processes to avoid making redundant copies of data, collaborate on a computation, and otherwise communicate with each other.  The concept of shared memory falls within the more general topic of interprocess communication.  You can read about both on Wikipedia:</p>
      <ul>
        <li>Shared memory: <a href="https://en.wikipedia.org/wiki/Shared_memory" target="_blank">https://en.wikipedia.org/wiki/Shared_memory</a></li>
        <li>Interprocess communication: <a href="https://en.wikipedia.org/wiki/Shared_memory" target="_blank">https://en.wikipedia.org/wiki/Inter-process_communication</a></li>
      </ul>
      
      <h4>Your Task</h4>
      
      <ol>
        <li>Create a new system call with the following signature:</li>
        <span class="code">void* shmem_access(int page_number)</span>
        <ul>
          <li>The syscall MUST use this exact interface.</li>
          <li>When a process calls this syscall, the kernel will make a shared page available to the process.</li>
          <li><span class="code">page_number</span> can range from 0 to 3, allowing up to four different pages to be shared.</li>
          <li>The four shared pages, if and when they are requested by a process, should be mapped to the highest four pages in the calling process’s virtual address space.</li>
          <li>The syscall will return the virtual address of the shared page.
            If a process calls this syscall twice with the same argument, the syscall should recognize that this process has already mapped this shared page and simply return the virtual address again.</li>
          <li>This syscall will indicate failure by returning NULL.</li>
        </ul>
        
        <li>Create another syscall with the following signature:</li>
        <span class="code">int shmem_count(int page_number)</span>
        <ul>
          <li>The syscall MUST use this exact interface.</li>
          <li>This syscall returns the number of processes that are currently sharing the shared page specified by the <span class="code">page_number</span> argument.</li>
          <li>This syscall will indicate failure by returning -1.</li>
        </ul>
        
        <li>Other requirements:</li>
        <ul>
          <li>If a user passes a bad argument to one of these syscalls, the syscall will indicate failure with its return value.</li>
          <li>When a process forks, the child process should automatically get access to the parent’s shared pages, if any.  Reference counts should be updated accordingly.</li>
          <li>If a virtual memory page is being used as shared memory, it cannot also be used as “normal” unshared memory and vice versa.</li>
          <li>No memory leaks.  For example, suppose several processes have been sharing a page, but now process #42 is the last process left alive that was using that page.  When process #42 terminates, the shared page must be freed.</li>
        </ul>
        
      </ol>
      
      <h4>Guidance and hints</h4>
      
      <ol>
        <li>Let’s look at an example.  Suppose process #3 calls <span class="code">shmem_access(0)</span> and that this page is not currently being shared by any other processes.  In this case, the syscall must allocate a new physical memory page, which will become the shared page, and map a virtual memory page to the physical address of the new physical memory page.  Now, if process #4 calls <span class="code">shmem_access(0)</span>, the syscall will map a virtual memory page in process #4’s address space to the physical address of the existing shared page.  Now the two processes can both read and write to the same memory.  The virtual addresses returned in the two processes may be the same or may be different--it's up to you.  However, both virtual addresses must be within the top four pages of the virtual address space.</li>
        <li>You will have to revisit many of the changes you made in Part 1.</li>
        <li>You will have to count references to each shared page.</li>
        <li>You already learned how to add new system calls in Project 1--follow the same approach.</li>
        <li>
          We are providing a user program called <span class="code"><a href="http://www.aqualab.cs.northwestern.edu/component/attachments/download/707">sharedmem_simpletests</a></span> with a few simple test cases.  However, these tests are deliberately not comprehensive.  You should add your own test cases to convince yourself that your code is working properly.  Be creative while thinking of all cases where things can go wrong.  You should be able to think of at least one test case for every bullet point in the <b>Your Task</b> section above.</br>
          (<span class="code">$ wget http://www.aqualab.cs.northwestern.edu/component/attachments/download/707 -O sharedmem_simpletests.c.tar.gz</span>)
        </li>
        <li>
          In part 1, we provided you a modified version of <span class="code">usertests</span>.  However, in part 2 we are invalidating even more of the assumptions that underly those tests.  Here is yet another modified version that you can use for part 2: <a href="http://www.aqualab.cs.northwestern.edu/component/attachments/download/704">usertests_2_2</a></br>
          <p>(<span class="code">$ wget http://www.aqualab.cs.northwestern.edu/component/attachments/download/704 -O usertests_2_2.c.tar.gz</span>)</p>
        </li>
      </ol>
      
      <h3>Extra Credit:</h3>
      <p><b>20 points</b></p>
      
      <p>Here is an extra credit assignment for those seeking a further challenge. Only attempt this if you are done with Parts 1 and 2.</p>
      
      <h4>Your Task</h4>
      
      <p>Depending on how you completed Part 2, you may have chosen to set aside four pages at the top of every process’s virtual address space to be used as needed for shared memory only.  If the processes are not sharing any memory with each other, this approach is wasting four pages of memory that could otherwise be used by the process for normal unshared purposes.  Now you will make these four pages available for general purpose use (like the rest of the process's memory) <i>or</i> shared use, depending on how the process needs them.  In other words, if the process never calls <span class="code">shmem_access</span>, but it does need all 160 pages of user memory for unshared purposes, that should be allowed.  Likewise, if the process needs 3 pages of shared memory and 157 pages of unshared memory, that should be allowed too.</p>
      
      <h4>Guidance and hints</h4>
      
      <ol>
        <li>The four pages that may be used for shared memory need some bookkeeping. (i.e. You want to be able to tell whether a given page is a shared page or not.) There are many ways to do this.  Where do you keep metadata about a page in memory? Can we add to that?</li>
        <li>Given the new constraints (the initial 4 pages can be either shared or general memory), you want to make sure you don’t break anything that’s already working from Part 1 and Part 2. Make sure you make xv6 check this in all memory-related functions.</li>
        <li>You will have to revisit many of the changes you made in Parts 1 and 2.</li>
        <li>Things can break while trying to make this work. Using version control is highly recommended for the purpose of this. (i.e. You can’t ask for extension because you had working versions of part 1 and 2, and things broke while you were attempting to do the extra credit.)  If you use a version control service such as github, make sure your repo is private.</li> 
        <li>We will try to provide a few test cases.  Any tests cases we provide are deliberately not comprehensive.  Again, be creative while thinking of all cases where things can go wrong and write your test cases accordingly.</br>
        UPDATE: The test cases are now posted here: <a href="https://piazza.com/class/id32r0aahkj1fo?cid=138" target="_blank">https://piazza.com/class/id32r0aahkj1fo?cid=138</a></li>
        <li>Disclaimers: The TAs will focus their attention on helping groups with parts 1 and 2.  You will mostly be on your own for the extra credit.  Also, it bears repeating, make sure you complete parts 1 and 2 before attempting the extra credit.</li>
      </ol>
      
      
      
      <p>Acknowledgements: This project is based on a similar project used by UW Madison in their OS course.</p>
      
    </div> <!-- project description -->
    
    <div id="submission">
      
      <h2>Submission Instructions</h2>
      
      <p>Please read all the instructions and follow them carefully.  Submissions for this project will be done through our submissions page here: <a href="https://www.cs.northwestern.edu/~aqualab/assignments/OS/submission.htm" target="_blank">https://www.cs.northwestern.edu/~aqualab/assignments/OS/submission.htm</a>  If you run into problems with the submission site, please see the troubleshooting insructions below.</p>
      
      <p>Please choose one group member to perform the submission.  Here are the instructions:</p>
      <ol>
        <li>In your <span class="code">xv6</span> directory, create a new file called <span class="code">team.txt</span>.  Type the netid of each team member on a separate line.  If your group has 3 members, your <span class="code">team.txt</span> file should have 3 lines.</li>
        <li>In your xv6 directory, type:<br/>
          <span class="code">make clean</span><br/>
          This removes all the .o and executable files, so that you will only submit your source code.
        </li>
        <li>cd to one directory above your xv6 directory.  Then create a .tar.gz of your xv6 directory by typing:<br/>
          <span class="code">tar -zcvf xv6-project2.tar.gz xv6</span><br/></li>
        <li>Go to the <a href="https://www.cs.northwestern.edu/~aqualab/assignments/OS/submission.htm" target="_blank">submission site</a>, select the appropriate choice from the drop-down menu, and upload your .tar.gz file.</li>
      </ol>
      
      <p>NOTE: If you submit your code before the deadline and then realize you need to change something, you can re-submit your code as long as it is the same group member who performs the submission.  Your last submission will be the one that gets graded.  However, if multiple group members submit multiple different versions of the code, well, I really have no idea what will happen, but it might not be pretty.  So please put one group member in charge of submitting your code.</p>
      
      <p><b>Troubleshooting Submissions:</b> If the submissions site won't load for you, please try the following steps:</p>
      <ul>
        <li>If you see a certificate warning, you'll have to add an exception for the site.  Sorry.</li>
        <li>If the page still fails to load, try using a different browser.</li>
        <li>If the page still fails to load, try using yet another different browser.  NOTE: Chrome and Firefox can be downloaded for free.</li>
        <li>If the page still fails to load, try connecting from a campus IP address.</li>
        <li>If you are on Windows, try going to a lab machine or using a friend's Mac.</li>
        <li>If all else fails, you can email the submission to one of the TAs.</li>
      </ul>
      
      
    </div> <!-- submission -->
    
  </div> <!-- main -->
</div> <!-- tabs --><div class="attachmentsContainer">

<div class="attachmentsList" id="attachmentsList_com_content_article_335">
<table>
<caption>Attachments:</caption>
<tbody>
<tr class="odd"><td class="at_filename"><a class="at_icon" href="/component/attachments/download/707" title="Download this file (sharedmem_simpletests.c.tar.gz)"><img src="/media/com_attachments/images/file_icons/archive.gif" alt="Download this file (sharedmem_simpletests.c.tar.gz)"  /></a><a class="at_url" href="/component/attachments/download/707" title="Download this file (sharedmem_simpletests.c.tar.gz)">sharedmem_simpletests.c.tar.gz</a></td></tr>
<tr class="even"><td class="at_filename"><a class="at_icon" href="/component/attachments/download/703" title="Download this file (usertests_2_1.c.tar.gz)"><img src="/media/com_attachments/images/file_icons/archive.gif" alt="Download this file (usertests_2_1.c.tar.gz)"  /></a><a class="at_url" href="/component/attachments/download/703" title="Download this file (usertests_2_1.c.tar.gz)">usertests_2_1.c.tar.gz</a></td></tr>
<tr class="odd"><td class="at_filename"><a class="at_icon" href="/component/attachments/download/704" title="Download this file (usertests_2_2.c.tar.gz)"><img src="/media/com_attachments/images/file_icons/archive.gif" alt="Download this file (usertests_2_2.c.tar.gz)"  /></a><a class="at_url" href="/component/attachments/download/704" title="Download this file (usertests_2_2.c.tar.gz)">usertests_2_2.c.tar.gz</a></td></tr>
</tbody></table>
</div>

</div>
	
</div>




<script src="http://www.google-analytics.com/urchin.js" type="text/javascript"> </script>
<script type="text/javascript"> _uacct = "UA-2595418-1"; urchinTracker(); </script>

</body>
</html>
